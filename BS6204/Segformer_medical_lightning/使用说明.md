# 医学图像分割系统 - 使用说明

## 📋 目录
1. [打包可执行文件](#打包可执行文件)
2. [运行打包后的程序](#运行打包后的程序)
3. [运行源代码版本](#运行源代码版本)
4. [分发给其他用户](#分发给其他用户)
5. [常见问题](#常见问题)

---

## 🎯 打包可执行文件

### 方法1：使用批处理脚本（推荐，最简单）

1. **打开项目文件夹**
   ```
   E:\VSCode_Project\BS6204\Segformer_medical_lightning\
   ```

2. **双击运行 `PyInstaller打包.bat`**
   - 直接双击文件即可
   - 或在命令行中运行：
     ```bash
     cd E:\VSCode_Project\BS6204\Segformer_medical_lightning
     PyInstaller打包.bat
     ```

3. **等待打包完成**
   - 预计需要 10-30 分钟
   - 会自动下载依赖、打包代码和模型

4. **查看打包结果**
   ```
   dist\
   └── Segformer_Medical_App\
       ├── Segformer_Medical_App.exe  👈 主程序
       ├── lightning_logs\             (模型文件)
       └── _internal\                  (依赖库)
   ```

### 方法2：手动使用 PyInstaller

```bash
# 1. 进入项目目录
cd E:\VSCode_Project\BS6204\Segformer_medical_lightning

# 2. 确保已安装 PyInstaller
pip install pyinstaller

# 3. 运行打包命令
pyinstaller --distpath dist --workpath build --noconfirm gradio_app.spec

# 4. 查看生成的文件
dir dist\Segformer_Medical_App
```

---

## 🚀 运行打包后的程序

### Windows 用户

1. **找到可执行文件**
   ```
   E:\VSCode_Project\BS6204\Segformer_medical_lightning\dist\Segformer_Medical_App\Segformer_Medical_App.exe
   ```

2. **双击运行**
   - 直接双击 `Segformer_Medical_App.exe`
   - 会弹出控制台窗口显示加载进度

3. **等待模型加载**
   - 首次启动需要加载模型（约 10-30 秒）
   - 控制台会显示：
     ```
     ============================================
     🏥 医学图像分割系统 - Gradio应用
     ============================================

     加载模型...
     模型加载成功！

     🚀 正在启动 Gradio 界面...
     Running on local URL:  http://127.0.0.1:7860
     ```

4. **打开浏览器**
   - 浏览器会自动打开应用界面
   - 如果没有自动打开，手动访问：`http://127.0.0.1:7860`

5. **开始使用**
   - 上传医学图像（PNG, JPG, JPEG）
   - 或点击示例图像快速测试
   - 点击"🚀 开始分割"按钮
   - 查看分割结果和统计信息

### 关闭程序

- 关闭浏览器标签页
- 在控制台窗口按 `Ctrl+C` 停止服务器
- 或直接关闭控制台窗口

---

## 💻 运行源代码版本

### 前提条件

1. **安装 Python 环境**
   - Python 3.8 或更高版本
   - Anaconda（推荐）

2. **安装依赖**
   ```bash
   cd E:\VSCode_Project\BS6204\Segformer_medical_lightning
   pip install -r requirements_packaging.txt
   ```

### 运行方法

```bash
# 方法1：直接运行
python gradio_app.py

# 方法2：在 Anaconda 环境中运行
conda activate Pytorch  # 激活你的环境
python gradio_app.py
```

### 预期输出

```
============================================
🏥 医学图像分割系统 - Gradio应用
============================================

加载模型: lightning_logs/version_0/checkpoints/best_model.ckpt
✅ 模型加载成功！

🚀 正在启动 Gradio 界面...
Running on local URL:  http://127.0.0.1:7860

To create a public link, set `share=True` in `launch()`.
```

---

## 📦 分发给其他用户

### 打包成 ZIP 文件

1. **找到打包后的文件夹**
   ```
   E:\VSCode_Project\BS6204\Segformer_medical_lightning\dist\Segformer_Medical_App\
   ```

2. **压缩整个文件夹**
   - 右键点击 `Segformer_Medical_App` 文件夹
   - 选择"发送到" → "压缩(zipped)文件夹"
   - 或使用 7-Zip/WinRAR 压缩

3. **分享给用户**
   - 将 `Segformer_Medical_App.zip` 发送给用户
   - 文件大小约 1-2 GB（包含所有依赖）

### 用户使用步骤

1. **解压文件**
   ```
   解压 Segformer_Medical_App.zip 到任意位置
   ```

2. **运行程序**
   ```
   双击 Segformer_Medical_App.exe
   ```

3. **无需安装 Python**
   - ✅ 所有依赖已打包
   - ✅ 模型文件已包含
   - ✅ 开箱即用

---

## ❓ 常见问题

### Q1: 双击 .exe 后没有反应？

**解决方案：**
```
1. 检查是否有杀毒软件拦截
2. 右键 → 以管理员身份运行
3. 查看控制台窗口是否有错误信息
4. 确保 lightning_logs 文件夹存在且包含模型文件
```

### Q2: 提示找不到模型文件？

**解决方案：**
```
确保目录结构完整：
Segformer_Medical_App\
├── Segformer_Medical_App.exe
└── lightning_logs\
    └── version_0\
        └── checkpoints\
            └── best_model.ckpt  👈 必须存在
```

### Q3: 打包时出现 "pathlib" 错误？

**解决方案：**
```bash
# 删除过时的 pathlib 包
rm -f E:\Anaconda\lib\site-packages\pathlib.py
rm -rf E:\Anaconda\lib\site-packages\pathlib-1.0.1.dist-info
```

### Q4: 打包时出现编码错误？

**解决方案：**
```
1. 确保批处理文件使用 UTF-8 编码
2. 或使用英文版本的批处理脚本
3. 直接使用 PyInstaller 命令打包
```

### Q5: 程序启动很慢？

**正常现象：**
```
- 首次启动需要加载深度学习模型（约 10-30 秒）
- 模型文件约 57 MB
- 后续预测速度会很快
```

### Q6: 如何创建公网链接？

**修改 gradio_app.py：**
```python
# 在 main() 函数中找到这一行：
demo.launch(
    server_name="127.0.0.1",
    share=False,  # 改为 True
    ...
)

# 改为：
demo.launch(
    server_name="127.0.0.1",
    share=True,  # 👈 启用公网链接
    ...
)
```

### Q7: 如何修改端口号？

**修改 gradio_app.py：**
```python
demo.launch(
    server_name="127.0.0.1",
    server_port=8888,  # 👈 指定端口号
    share=False
)
```

---

## 📞 技术支持

- 项目路径：`E:\VSCode_Project\BS6204\Segformer_medical_lightning\`
- 模型架构：SegFormer (NVIDIA MIT-B0)
- 框架：PyTorch Lightning + Gradio
- 训练轮数：100 epochs

---

## 🎨 界面预览

启动后会看到：
- 🏥 专业的渐变标题
- 📤 图像上传区域
- 🎨 颜色图例（黑/红/绿/蓝）
- 🖼️ 6 张示例图像
- 📊 分割结果和统计信息

---

**最后更新：** 2025-10-19
